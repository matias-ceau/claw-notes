#!/data/data/com.termux/files/usr/bin/bash
# Claw Notes - CLI Entry Point (infrastructure only)
#
# NOTE: Users interact via widgets and WhatsApp, not this CLI.
# This exists for debugging and automation.

set -e

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
source "$SCRIPT_DIR/../lib/config.sh"

show_help() {
    cat << 'EOF'
Claw Notes - CLI (for debugging/automation)

NOTE: Normal usage is via widgets or WhatsApp, not this CLI.

Commands:
  record [name]       Record voice note â†’ send to OpenClaw
  note <title>        Create quick text note
  journal [text]      Add to today's journal
  sync [message]      Git commit and push
  start               Start OpenClaw gateway
  stop                Stop OpenClaw gateway
  status              Show system status

Voice transcription is handled by OpenClaw's audio pipeline.
Send voice notes via WhatsApp for the best experience.
EOF
}

cmd_status() {
    echo "=== Claw Notes Status ==="
    echo ""
    echo "Vault: $CLAW_ROOT"
    echo ""

    echo "Notes:"
    for dir in "$VAULT_PAGES" "$VAULT_JOURNALS" "$VAULT_TRANSCRIPTS_RAW"; do
        if [ -d "$dir" ]; then
            count=$(find "$dir" -type f -name "*.md" 2>/dev/null | wc -l)
            echo "  $(basename "$dir"): $count files"
        fi
    done
    echo ""

    echo "OpenClaw:"
    if openclaw_running; then
        log_ok "Running on $OPENCLAW_HOST:$OPENCLAW_PORT"
    else
        log_warn "Not running (start with: claw start)"
    fi
    echo ""

    echo "Git:"
    if [ -d "$CLAW_ROOT/.git" ]; then
        cd "$CLAW_ROOT"
        branch=$(git branch --show-current 2>/dev/null || echo "unknown")
        changes=$(git status --porcelain 2>/dev/null | wc -l)
        echo "  Branch: $branch"
        echo "  Uncommitted: $changes"
    else
        log_warn "Not a git repo"
    fi
}

cmd_start() {
    if openclaw_running; then
        log_warn "OpenClaw already running"
        return 0
    fi

    log_info "Starting OpenClaw..."

    if is_termux; then
        termux-wake-lock 2>/dev/null || true
    fi

    HIJACK="$CLAW_LIB/hijack.js"
    if [ -f "$HIJACK" ]; then
        node -r "$HIJACK" "$(which openclaw)" gateway &
    else
        openclaw gateway &
    fi

    sleep 2
    if openclaw_running; then
        log_ok "OpenClaw started"
        # Show notification on Termux
        if is_termux; then
            termux-notification \
                --id claw-assistant \
                --title "Claw Assistant" \
                --content "Running" \
                --ongoing 2>/dev/null || true
        fi
    else
        log_error "Failed to start"
        return 1
    fi
}

cmd_stop() {
    if ! openclaw_running; then
        log_warn "OpenClaw not running"
        return 0
    fi

    log_info "Stopping OpenClaw..."
    pkill -f "openclaw" 2>/dev/null || true

    if is_termux; then
        termux-wake-unlock 2>/dev/null || true
        termux-notification-remove claw-assistant 2>/dev/null || true
    fi

    log_ok "Stopped"
}

cmd_sync() {
    cd "$CLAW_ROOT"

    msg="${1:-Auto-sync $(date '+%Y-%m-%d %H:%M')}"

    if [ -z "$(git status --porcelain)" ]; then
        log_info "Nothing to sync"
        return 0
    fi

    log_info "Syncing..."
    git add -A
    git commit -m "$msg"

    if git remote -v | grep -q origin; then
        git push origin HEAD 2>/dev/null && log_ok "Pushed" || log_warn "Push failed"
    fi

    log_ok "Synced"
}

# Dispatch
case "${1:-help}" in
    record)
        shift
        "$CLAW_BIN/claw-record" "$@"
        ;;
    note)
        shift
        "$CLAW_BIN/claw-note" "$@"
        ;;
    journal)
        shift
        "$CLAW_BIN/claw-journal" "$@"
        ;;
    sync)
        shift
        cmd_sync "$@"
        ;;
    start)
        cmd_start
        ;;
    stop)
        cmd_stop
        ;;
    status)
        cmd_status
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        log_error "Unknown command: $1"
        echo "Run 'claw help' for usage"
        exit 1
        ;;
esac
