#!/data/data/com.termux/files/usr/bin/bash
# Background task: Process voice recording
# Called by "Record Voice" widget after recording completes

CLAW_ROOT="$(cd "$(dirname "$0")/../.." && pwd)"
source "$CLAW_ROOT/.claw/lib/config.sh"

AUDIO="$1"
NAME="$2"

if [ -z "$AUDIO" ] || [ ! -f "$AUDIO" ]; then
    termux-notification --title "Error" --content "No audio file"
    exit 1
fi

termux-wake-lock

# Transcribe with Whisper
termux-notification --id claw-process --title "Transcribing..." --content "$NAME" --ongoing

TRANSCRIPT="$VAULT_TRANSCRIPTS_RAW/${NAME}_transcript.md"

if command -v whisper &> /dev/null; then
    whisper "$AUDIO" \
        --model "$WHISPER_MODEL" \
        --language "$WHISPER_LANGUAGE" \
        --output_format txt \
        --output_dir "$CLAW_CACHE" 2>/dev/null

    WHISPER_OUT="$CLAW_CACHE/$(basename "${AUDIO%.*}").txt"

    if [ -f "$WHISPER_OUT" ]; then
        cat > "$TRANSCRIPT" << EOF
---
type: transcript
created: $(date -Iseconds)
source: voice
audio: $(basename "$AUDIO")
tags: []
---

# $NAME

$(cat "$WHISPER_OUT")
EOF
        rm -f "$WHISPER_OUT"
    else
        termux-notification-remove claw-process
        termux-notification --title "Transcription failed" --content "Whisper error"
        termux-wake-unlock
        exit 1
    fi
else
    # Fallback: just save audio reference
    cat > "$TRANSCRIPT" << EOF
---
type: transcript
created: $(date -Iseconds)
source: voice
audio: $(basename "$AUDIO")
tags: [needs-transcription]
---

# $NAME

*Audio file: [[assets/$(basename "$AUDIO")]]*

(Whisper not installed - manual transcription needed)
EOF
fi

# Process with LLM if OpenClaw running
if openclaw_running; then
    termux-notification --id claw-process --title "Processing with AI..." --content "$NAME" --ongoing

    CLEANED="$VAULT_TRANSCRIPTS_CLEAN/${NAME}_cleaned.md"
    SUMMARY="$VAULT_SUMMARIES/${NAME}_summary.md"

    "$CLAW_BIN/claw-process" "$TRANSCRIPT" 2>/dev/null
fi

termux-notification-remove claw-process
termux-wake-unlock

# Final notification with action to view
termux-notification \
    --title "Note ready" \
    --content "$NAME" \
    --button1 "View" \
    --button1-action "termux-open '$TRANSCRIPT'"

termux-vibrate -d 200
