#!/data/data/com.termux/files/usr/bin/bash
# Widget: Record Voice Note
# Records audio and sends to OpenClaw for transcription

CLAW_ROOT="$(cd "$(dirname "$0")/.." && pwd)"
source "$CLAW_ROOT/.claw/lib/config.sh"

ensure_dirs

NAME="voice_$(timestamp)"
AUDIO="$VAULT_ASSETS/${NAME}.m4a"

# Show recording notification
termux-notification \
    --id claw-record \
    --title "Recording..." \
    --content "Tap Stop when done" \
    --ongoing \
    --button1 "Stop" \
    --button1-action "termux-microphone-record -q"

# Record (max 5 min, stops on notification tap)
termux-wake-lock
termux-microphone-record -f "$AUDIO" -l "$RECORD_LIMIT"

# Clear recording notification
termux-notification-remove claw-record

# Check if we got audio
if [ ! -f "$AUDIO" ] || [ ! -s "$AUDIO" ]; then
    termux-wake-unlock
    termux-toast "Recording cancelled"
    exit 0
fi

termux-toast "Sending to assistant..."

# Send to OpenClaw for processing
# OpenClaw handles transcription via its audio pipeline
"$CLAW_ROOT/.shortcuts/tasks/send-to-openclaw" "$AUDIO" "$NAME" &

termux-wake-unlock
