#!/data/data/com.termux/files/usr/bin/bash
#
# Claw Notes Widget: Cloud Sync
#
# Syncs vault to configured cloud storage (Google Drive, Mega, etc.)
# Run 'claw-sync --setup' first to configure cloud provider.

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"

# Try to find claw-notes root
if [ -f "$HOME/.config/claw-notes/config" ]; then
    source "$HOME/.config/claw-notes/config"
fi

CLAW_ROOT="${CLAW_ROOT:-$HOME/claw-notes}"

# Source config
if [ -f "$CLAW_ROOT/.claw/lib/config.sh" ]; then
    source "$CLAW_ROOT/.claw/lib/config.sh"
fi

# Check if rclone is configured
if ! command -v rclone &> /dev/null; then
    termux-toast "rclone not installed. Run setup.sh"
    exit 1
fi

RCLONE_REMOTE="${RCLONE_REMOTE:-claw-notes}"

if ! rclone listremotes 2>/dev/null | grep -q "^${RCLONE_REMOTE}:"; then
    termux-toast "Cloud not configured. Run: claw-sync --setup"
    termux-notification \
        --id "cloud-sync" \
        --title "Cloud Sync Not Configured" \
        --content "Run: claw-sync --setup"
    exit 1
fi

# Show sync options
choice=$(termux-dialog sheet \
    -t "Cloud Sync" \
    -v "Sync (bidirectional),Push to cloud,Pull from cloud,Show status" \
    2>/dev/null | jq -r '.text // empty')

case "$choice" in
    "Sync (bidirectional)")
        termux-notification --id "cloud-sync" --title "Cloud Sync" --content "Syncing..." --ongoing
        termux-vibrate -d 100

        if "$CLAW_ROOT/.claw/bin/claw-sync" 2>&1; then
            termux-notification --id "cloud-sync" --title "Cloud Sync" --content "Sync complete"
            termux-toast "Vault synced"
        else
            termux-notification --id "cloud-sync" --title "Cloud Sync" --content "Sync failed"
            termux-toast "Sync failed"
        fi
        ;;
    "Push to cloud")
        termux-notification --id "cloud-sync" --title "Cloud Sync" --content "Uploading..." --ongoing
        termux-vibrate -d 100

        if "$CLAW_ROOT/.claw/bin/claw-sync" --push 2>&1; then
            termux-notification --id "cloud-sync" --title "Cloud Sync" --content "Upload complete"
            termux-toast "Uploaded to cloud"
        else
            termux-notification --id "cloud-sync" --title "Cloud Sync" --content "Upload failed"
        fi
        ;;
    "Pull from cloud")
        # Confirm destructive action
        confirm=$(termux-dialog confirm \
            -t "Pull from Cloud" \
            -i "This will overwrite local vault with cloud version. Continue?" \
            2>/dev/null | jq -r '.text // empty')

        if [ "$confirm" = "yes" ]; then
            termux-notification --id "cloud-sync" --title "Cloud Sync" --content "Downloading..." --ongoing
            termux-vibrate -d 100

            # Force pull without interactive prompt
            RCLONE_PATH="${RCLONE_PATH:-ClawNotes-Vault}"
            if rclone sync "$RCLONE_REMOTE:$RCLONE_PATH" "$VAULT_ROOT" --progress 2>&1; then
                termux-notification --id "cloud-sync" --title "Cloud Sync" --content "Download complete"
                termux-toast "Vault restored from cloud"
            else
                termux-notification --id "cloud-sync" --title "Cloud Sync" --content "Download failed"
            fi
        else
            termux-toast "Cancelled"
        fi
        ;;
    "Show status")
        status=$("$CLAW_ROOT/.claw/bin/claw-sync" --status 2>&1)
        termux-dialog text -t "Cloud Sync Status" -i "$status" 2>/dev/null
        ;;
    *)
        termux-toast "Cancelled"
        ;;
esac
